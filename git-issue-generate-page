#!/bin/bash

# Generate a single-page HTML with embedded JS/CSS for browsing git-issue refs
# - Builds the React app under web/
# - Inlines built JS and CSS into one self-contained index.html
# - Writes output to docs/index.html (creating docs/ if needed)
#
# Requirements: node/npm, vite

generate-page() {
  set -euo pipefail

  # Build the web app
  echo "[git-issue] Building web app..."
  npm --prefix "$(dirname "$0")/web" install >/dev/null 2>&1 || true
  npm --prefix "$(dirname "$0")/web" run build

  local dist_dir="$(dirname "$0")/web/dist"
  local assets_dir="$dist_dir/assets"

  if [ ! -d "$dist_dir" ]; then
    echo "Build output not found: $dist_dir" >&2
    exit 1
  fi

  # Find built asset files
  local css_file js_file
  css_file=$(ls "$assets_dir"/*.css 2>/dev/null | head -n1 || true)
  js_file=$(ls "$assets_dir"/*.js 2>/dev/null | head -n1 || true)

  if [ -z "$js_file" ]; then
    echo "No JS asset found in $assets_dir" >&2
    exit 1
  fi

  # Read base HTML
  local base_html
  base_html=$(cat "$dist_dir/index.html")

  # Inline CSS if present
  local inline_css=""
  if [ -n "$css_file" ]; then
    inline_css=$(cat "$css_file")
    base_html=$(echo "$base_html" | sed "s#<link rel=\\\"stylesheet\\\" href=\\\"/assets/[^\\\"]*\\\">#<style>$inline_css</style>#")
  fi

  # Inline JS
  local inline_js
  inline_js=$(cat "$js_file")
  # Replace the script tag that points to /assets/index-*.js with inline
  base_html=$(echo "$base_html" | sed "s#<script type=\\\"module\\\" crossorigin src=\\\"/assets/[^\\\"]*\\\"></script>#<script type=\"module\">$inline_js</script>#")

  # Ensure root script (in dev index) is removed/handled
  base_html=$(echo "$base_html" | sed "s#<script type=\\\"module\\\" src=\\\"/src/main.jsx\\\"></script>##g")

  # Write to docs/index.html
  local out_dir="$(dirname "$0")/docs"
  mkdir -p "$out_dir"
  echo "$base_html" > "$out_dir/index.html"

  echo "[git-issue] Generated page: $out_dir/index.html"
}

# Allow direct execution
if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  generate-page "$@"
fi
